#!/bin/bash
# Auto-sync: pull --rebase before every commit to avoid conflicts
# between multiple Claude instances (Cowork + Claude Code on Replit)
#
# Strategy: only pull if no rebase needed (fast-forward), otherwise warn.
# We do NOT stash ‚Äî previous stash approach was losing staged changes.

echo "üîÑ Auto-syncing with remote before commit..."

# Fetch latest without merging
git fetch origin main --quiet 2>/dev/null

# Check if we're behind
LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse origin/main 2>/dev/null)

if [ "$LOCAL" = "$REMOTE" ]; then
  echo "‚úÖ Already up to date. Proceeding with commit."
  exit 0
fi

# Check if fast-forward is possible (local is ancestor of remote)
if git merge-base --is-ancestor HEAD origin/main 2>/dev/null; then
  # Safe to rebase ‚Äî but we can't rebase with staged changes.
  # Just warn and let the commit proceed; user can pull after.
  echo "‚ö†Ô∏è  Remote has new commits. Commit will proceed, but run 'git pull --rebase' after."
  exit 0
fi

# Local has diverged ‚Äî warn but don't block
echo "‚ö†Ô∏è  Local and remote have diverged. Commit will proceed, but reconcile after."
exit 0
