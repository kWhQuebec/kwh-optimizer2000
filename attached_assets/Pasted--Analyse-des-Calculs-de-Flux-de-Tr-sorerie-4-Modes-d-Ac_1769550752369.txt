
# üîç Analyse des Calculs de Flux de Tr√©sorerie - 4 Modes d'Acquisition

## üìä R√©sum√© des Probl√®mes Identifi√©s

### ‚ö†Ô∏è PROBL√àME MAJEUR: Deux syst√®mes de calcul diff√©rents!

Il y a **deux impl√©mentations parall√®les** des calculs de cashflow qui ne sont pas synchronis√©es:

| Fichier | Modes | Utilis√© o√π? |
|---------|-------|-------------|
| `shared/finance/cashflowEngine.ts` | 3 modes (Cash, Lease, PPA) | Market Intelligence |
| `client/src/pages/site-detail.tsx` | 4 modes (Cash, **Loan**, Lease, PPA) | Site Detail / Financing Calculator |

**Le mode "Loan" (Pr√™t) n'existe PAS dans `cashflowEngine.ts`!**

---

## üìã D√©tail des Calculs par Mode

### 1. üíµ MODE CASH (Comptant)

#### Dans `site-detail.tsx`:
```javascript
// Day 0: Pay Gross CAPEX, receive HQ Solar rebate immediately
upfrontCashNeeded = capexGross - hqSolar - (hqBattery * 0.5)
year1Returns = (hqBattery * 0.5) + taxShield
year2Returns = federalITC
totalIncentives = hqSolar + hqBattery + federalITC + taxShield
netSavings = annualSavings * 25 - capexNet
```

#### Dans `cashflowEngine.ts`:
```javascript
// Investissement initial
netClientInvestment = grossCapex - hqIncentive - itc
cashCumulative = -netClientInvestment

// Chaque ann√©e
ccaBenefit = ucc * ccaRate * taxRate  // CCA declining balance
cashNet = gridSavings - omCost + ccaBenefit
```

#### ‚ùå Probl√®mes identifi√©s:
1. **Timing des incitatifs diff√©rent**: `site-detail` s√©pare Year 0/1/2, `cashflowEngine` applique tout au d√©but
2. **CCA calcul√© diff√©remment**: `cashflowEngine` utilise declining balance, `site-detail` utilise un "tax shield" fixe
3. **O&M costs**: `cashflowEngine` inclut O&M, `site-detail` ne l'inclut PAS dans le cash flow
4. **Batterie**: `site-detail` inclut HQ Battery incentive, `cashflowEngine` ne g√®re que HQ Solar

---

### 2. üí≥ MODE LOAN (Pr√™t) - ‚ö†Ô∏è MANQUANT DANS cashflowEngine!

#### Dans `site-detail.tsx` seulement:
```javascript
loanDownPaymentAmount = capexGross * downPayment / 100
loanAmount = capexGross - loanDownPaymentAmount
monthlyPayment = standard_amortization_formula(loanAmount, rate, term)
totalLoanPayments = monthlyPayment * numPayments + loanDownPaymentAmount
effectiveLoanCost = totalLoanPayments - totalIncentives
netSavings = annualSavings * 25 - effectiveLoanCost
```

#### ‚ùå Probl√®me:
- **MODE LOAN N'EXISTE PAS dans `cashflowEngine.ts`**
- Si Market Intelligence utilise `cashflowEngine`, le mode Loan ne sera pas disponible l√†
- Incoh√©rence entre les deux vues de l'application

---

### 3. üìÑ MODE LEASE (Cr√©dit-bail)

#### Dans `site-detail.tsx`:
```javascript
leaseFinancedAmount = capexGross  // Full CAPEX financed
leaseMonthlyPayment = standard_amortization_formula(leaseFinancedAmount, implicitRate, term)
leaseTotalPayments = leaseMonthlyPayment * numPayments
leaseTotalIncentives = hqSolar + hqBattery + federalITC + taxShield // ALL incentives
effectiveLeaseCost = leaseTotalPayments - leaseTotalIncentives
leaseNetSavings = annualSavings * 25 - effectiveLeaseCost
```

#### Dans `cashflowEngine.ts`:
```javascript
// Paiement de lease calcul√© diff√©remment!
leasePayment = netClientInvestment / leaseTerm * (1 + leasePremium)  // ‚ö†Ô∏è Pas d'amortization formula!

// Cashflow annuel
leaseNet = gridSavings - omCost - leasePaymentThisYear
```

#### ‚ùå Probl√®mes identifi√©s:
1. **Calcul du paiement DIFF√âRENT**:
   - `site-detail`: Formule d'amortissement standard (comme un pr√™t)
   - `cashflowEngine`: Simple division + premium (`cost/term * 1.15`)
2. **Base de financement DIFF√âRENTE**:
   - `site-detail`: `capexGross` (avant incitatifs)
   - `cashflowEngine`: `netClientInvestment` (apr√®s HQ + ITC!)
3. **Incitatifs**:
   - `site-detail`: Client re√ßoit TOUS les incitatifs (HQ, ITC, tax shield)
   - `cashflowEngine`: Pas clair qui re√ßoit les incitatifs
4. **O&M**: `cashflowEngine` inclut O&M, `site-detail` non

---

### 4. ‚ö° MODE PPA (Power Purchase Agreement)

#### Dans `site-detail.tsx`:
```javascript
hqTariffRate = tariffCode === "M" ? 0.06061 : 0.11933
ppaYear1Annual = production * hqTariffRate * (ppaYear1Rate / 100)  // 100% Year 1
ppaYear2Annual = production * hqTariffRate * (ppaYear2Rate / 100)  // 60% Year 2+
ppaTotalPayments = ppaYear1Annual + (ppaYear2Annual * (ppaTerm - 1))

// Pendant le PPA: savings = HQ rate - PPA rate
// Apr√®s le PPA: full savings (client owns system)
```

#### Dans `cashflowEngine.ts`:
```javascript
// Pendant le PPA
trcRate = gridRateY1 * (1 + trcInflation)^year * (1 - ppaDiscount)  // 40% discount
ppaPayment = production * trcRate
ppaNet = gridSavings - ppaPayment

// Apr√®s le PPA
solarValue = production * gridRate
ppaPayment = solarValue * ppaOmRate  // 7% O&M
ppaNet = solarValue - ppaPayment
```

#### ‚ùå Probl√®mes identifi√©s:
1. **Mod√®le de tarification DIFF√âRENT**:
   - `site-detail`: Year 1 = 100%, Year 2+ = 60% du tarif HQ (TRC Solar model)
   - `cashflowEngine`: Discount fixe de 40% sur gridRate, avec inflation TRC
2. **Apr√®s la fin du PPA**:
   - `site-detail`: Client obtient √©lectricit√© 100% gratuite
   - `cashflowEngine`: Client...